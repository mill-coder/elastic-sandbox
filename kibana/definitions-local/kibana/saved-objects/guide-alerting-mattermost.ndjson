{"attributes": {"controlGroupInput": {"chainingSystem": "HIERARCHICAL", "controlStyle": "oneLine", "ignoreParentSettingsJSON": "{\"ignoreFilters\": false, \"ignoreQuery\": false, \"ignoreTimerange\": false, \"ignoreValidations\": false}", "panelsJSON": "{}", "showApplySelections": false}, "description": "Detailed guide for defining alerts and shipping notifications to Mattermost", "kibanaSavedObjectMeta": {"searchSourceJSON": "{\"filter\": [], \"query\": {\"query\": \"\", \"language\": \"kuery\"}}"}, "optionsJSON": "{\"useMargins\": true, \"syncColors\": false, \"syncCursor\": true, \"syncTooltips\": false, \"hidePanelTitles\": false}", "panelsJSON": "[{\"type\": \"visualization\", \"embeddableConfig\": {\"savedVis\": {\"title\": \"Overview\", \"description\": \"\", \"type\": \"markdown\", \"params\": {\"fontSize\": 12, \"openLinksInNewTab\": false, \"markdown\": \"## How Alerting Works in this Sandbox\\n\\nThe sandbox provides an end-to-end alerting pipeline:\\n\\n```\\n\\u250c\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2510     \\u250c\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2510     \\u250c\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2510     \\u250c\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2510\\n\\u2502  .alert file \\u2502\\u2500\\u2500\\u2500\\u2500\\u25b6\\u2502  deploy script    \\u2502\\u2500\\u2500\\u2500\\u2500\\u25b6\\u2502   Kibana     \\u2502\\u2500\\u2500\\u2500\\u2500\\u25b6\\u2502 Mattermost  \\u2502\\n\\u2502  (JSON)      \\u2502     \\u2502 deploy-kibana-    \\u2502     \\u2502  Rules +     \\u2502     \\u2502  Webhook    \\u2502\\n\\u2502              \\u2502     \\u2502  alerts.sh        \\u2502     \\u2502  Connectors  \\u2502     \\u2502  Channel    \\u2502\\n\\u2514\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2518     \\u2514\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2518     \\u2514\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2518     \\u2514\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2500\\u2518\\n```\\n\\n### What the deploy script does\\n\\n1. Reads each `.alert` JSON file from the alerts directory\\n2. Looks up the Mattermost webhook connector by `connector_name`\\n3. Creates or updates a Kibana alerting rule with the specified parameters\\n4. Wires up the action (connector + message template) for each action group\\n\\n### Supported rule types\\n\\n| Type | Key | Use case |\\n|------|-----|----------|\\n| ES Query | `es-query` | Fires when an Elasticsearch query matches documents |\\n| Index Threshold | `index-threshold` | Fires when an aggregation crosses a threshold |\"}, \"uiState\": {}, \"data\": {\"aggs\": [], \"searchSource\": {\"query\": {\"query\": \"\", \"language\": \"kuery\"}, \"filter\": []}}}, \"enhancements\": {}}, \"panelIndex\": \"ag-overview\", \"gridData\": {\"i\": \"ag-overview\", \"x\": 0, \"y\": 0, \"w\": 48, \"h\": 12}}, {\"type\": \"visualization\", \"embeddableConfig\": {\"savedVis\": {\"title\": \"Step-by-Step Guide\", \"description\": \"\", \"type\": \"markdown\", \"params\": {\"fontSize\": 12, \"openLinksInNewTab\": false, \"markdown\": \"## Step-by-Step Guide\\n\\n### 1. Start the stack\\n\\n```bash\\npodman compose -f install/compose.yaml \\\\\\n  --env-file install/local/.env \\\\\\n  --profile kibana --profile mattermost up -d\\n```\\n\\nThis starts: Elasticsearch, Kibana, Mattermost (+ PostgreSQL), and the init containers that auto-configure everything.\\n\\n### 2. Mattermost auto-configures\\n\\nThe `mattermost-init` process (if present) or manual setup creates:\\n- **Teams** (e.g., `SERVERS`)\\n- **Channels** \\u2014 `elastic-alerts` channel per team\\n- **Incoming Webhooks** \\u2014 one per team, named `Mattermost - {TEAM} Team`\\n\\nThese webhook URLs are registered as **Kibana connectors** by the deploy script.\\n\\n### 3. Write an `.alert` file\\n\\nCreate a JSON file in `mattermost/definitions-local/kibana/alerts/`. Example:\\n\\n```json\\n{\\n  \\\"key\\\": \\\"heartbeat-monitor-down\\\",\\n  \\\"name\\\": \\\"Logstash Monitor DOWN\\\",\\n  \\\"rule_type\\\": \\\"es-query\\\",\\n  \\\"enabled\\\": true,\\n  \\\"tags\\\": [\\\"monitor\\\", \\\"logstash\\\", \\\"mattermost\\\"],\\n  \\\"schedule_interval\\\": \\\"10s\\\",\\n  \\\"actions\\\": [\\n    {\\n      \\\"connector_name\\\": \\\"Mattermost - SERVERS Team\\\",\\n      \\\"group\\\": \\\"query matched\\\",\\n      \\\"message\\\": \\\":warning: **{{rule.name}}** ...\\\"\\n    },\\n    {\\n      \\\"connector_name\\\": \\\"Mattermost - SERVERS Team\\\",\\n      \\\"group\\\": \\\"recovered\\\",\\n      \\\"message\\\": \\\":white_check_mark: **Recovered** ...\\\"\\n    }\\n  ],\\n  \\\"params\\\": {\\n    \\\"index_pattern\\\": \\\"logs-*\\\",\\n    \\\"time_field\\\": \\\"@timestamp\\\",\\n    \\\"time_window\\\": {\\\"size\\\": 1, \\\"unit\\\": \\\"m\\\"},\\n    \\\"threshold\\\": {\\\"comparator\\\": \\\">=\\\", \\\"value\\\": 1},\\n    \\\"size\\\": 100,\\n    \\\"query\\\": {\\\"query\\\": {\\\"bool\\\": {\\\"filter\\\": [...]}}}\\n  }\\n}\\n```\\n\\n### 4. Deploy\\n\\n```bash\\ninstall/deploy-kibana-alerts.sh\\n```\\n\\nThe script creates the rule in Kibana and wires up the Mattermost connector actions.\\n\\n### 5. Verify\\n\\n- Open [Mattermost](http://localhost:8065) \\u2014 login as `admin` / `Admin123!`\\n- Check the `elastic-alerts` channel for incoming messages\\n- In Kibana, go to [Alerting Rules](/app/management/insightsAndAlerting/triggersActions/rules) to see rule status\\n\\n### 6. Iterate\\n\\nEdit your `.alert` file and re-run the deploy script. Adjust:\\n- `schedule_interval` for check frequency\\n- `message` templates using Mustache variables (see reference below)\\n- `params` for query conditions and thresholds\"}, \"uiState\": {}, \"data\": {\"aggs\": [], \"searchSource\": {\"query\": {\"query\": \"\", \"language\": \"kuery\"}, \"filter\": []}}}, \"enhancements\": {}}, \"panelIndex\": \"ag-steps\", \"gridData\": {\"i\": \"ag-steps\", \"x\": 0, \"y\": 12, \"w\": 48, \"h\": 26}}, {\"type\": \"visualization\", \"embeddableConfig\": {\"savedVis\": {\"title\": \".alert File Format\", \"description\": \"\", \"type\": \"markdown\", \"params\": {\"fontSize\": 12, \"openLinksInNewTab\": false, \"markdown\": \"## `.alert` File Format\\n\\nEach `.alert` file is a JSON object with the following fields:\\n\\n| Field | Type | Required | Description |\\n|-------|------|----------|-------------|\\n| `key` | string | yes | Unique identifier for the rule (used for create/update idempotency) |\\n| `name` | string | yes | Display name shown in Kibana |\\n| `rule_type` | string | yes | `es-query` or `index-threshold` |\\n| `enabled` | boolean | no | Whether the rule is active (default: `true`) |\\n| `tags` | string[] | no | Tags for organizing and filtering rules |\\n| `schedule_interval` | string | yes | How often to check (e.g., `10s`, `1m`, `5m`) |\\n| `actions` | object[] | yes | List of notification actions |\\n| `params` | object | yes | Rule-type-specific parameters |\\n\\n### `actions[]` fields\\n\\n| Field | Type | Description |\\n|-------|------|-------------|\\n| `connector_name` | string | Name of the Kibana connector (must match exactly) |\\n| `group` | string | Action group: `query matched` / `recovered` (ES Query) or `threshold met` / `recovered` (Index Threshold) |\\n| `message` | string | Mustache template for the notification message |\\n\\n### `params` for ES Query (`rule_type: es-query`)\\n\\n| Field | Description |\\n|-------|-------------|\\n| `index_pattern` | Index pattern to query (e.g., `logs-*`) |\\n| `time_field` | Timestamp field (usually `@timestamp`) |\\n| `time_window` | `{\\\"size\\\": N, \\\"unit\\\": \\\"s/m/h/d\\\"}` \\u2014 look-back window |\\n| `threshold` | `{\\\"comparator\\\": \\\">=\\\", \\\"value\\\": N}` \\u2014 when to fire |\\n| `size` | Max documents to return in context |\\n| `query` | Full Elasticsearch query DSL |\\n\\n### `params` for Index Threshold (`rule_type: index-threshold`)\\n\\n| Field | Description |\\n|-------|-------------|\\n| `index` | Index or index pattern |\\n| `timeField` | Timestamp field |\\n| `aggType` | Aggregation: `count`, `avg`, `sum`, `min`, `max` |\\n| `aggField` | Field to aggregate (not needed for `count`) |\\n| `groupBy` | `all` or `top` with `termSize` and `termField` |\\n| `threshold` | Numeric threshold value(s) |\\n| `thresholdComparator` | `>`, `>=`, `<`, `<=`, `between`, `notBetween` |\\n| `timeWindowSize` | Look-back window size |\\n| `timeWindowUnit` | `s`, `m`, `h`, `d` |\"}, \"uiState\": {}, \"data\": {\"aggs\": [], \"searchSource\": {\"query\": {\"query\": \"\", \"language\": \"kuery\"}, \"filter\": []}}}, \"enhancements\": {}}, \"panelIndex\": \"ag-alert-fmt\", \"gridData\": {\"i\": \"ag-alert-fmt\", \"x\": 0, \"y\": 38, \"w\": 24, \"h\": 22}}, {\"type\": \"visualization\", \"embeddableConfig\": {\"savedVis\": {\"title\": \"Mustache Template Reference\", \"description\": \"\", \"type\": \"markdown\", \"params\": {\"fontSize\": 12, \"openLinksInNewTab\": false, \"markdown\": \"## Mustache Template Variable Reference\\n\\n### Common variables (all rule types)\\n\\n| Variable | Description |\\n|----------|-------------|\\n| `{{date}}` | ISO timestamp when the rule scheduled the action |\\n| `{{kibanaBaseUrl}}` | Server public base URL |\\n| `{{rule.id}}` | Rule unique identifier |\\n| `{{rule.name}}` | Rule display name |\\n| `{{rule.params}}` | Rule parameters object (JSON) |\\n| `{{rule.spaceId}}` | Kibana space ID |\\n| `{{rule.tags}}` | Tags array \\u2014 iterate with `{{#rule.tags}}{{.}} {{/rule.tags}}` |\\n| `{{rule.url}}` | Direct link to the rule in Kibana |\\n\\n### Alert-level variables (non-summary actions)\\n\\n| Variable | Description |\\n|----------|-------------|\\n| `{{alert.id}}` | Alert instance ID |\\n| `{{alert.uuid}}` | Persistent UUID (constant while alert is active) |\\n| `{{alert.actionGroup}}` | Action group ID (`query matched`, `recovered`) |\\n| `{{alert.actionGroupName}}` | Human-readable action group name |\\n| `{{alert.consecutiveMatches}}` | Consecutive runs meeting the condition |\\n| `{{alert.flapping}}` | Whether the alert is oscillating between states |\\n\\n### ES Query context (`rule_type: es-query`)\\n\\n| Variable | Description |\\n|----------|-------------|\\n| `{{context.title}}` | Pre-built title, e.g. `rule 'my-rule' matched query` |\\n| `{{context.message}}` | Pre-built message with value, conditions, timestamp |\\n| `{{context.conditions}}` | Human-readable condition |\\n| `{{context.value}}` | Numeric value that crossed the threshold |\\n| `{{context.date}}` | ISO timestamp when condition was met |\\n| `{{context.link}}` | URL to alert details in Kibana |\\n| `{{context.hits}}` | Array of matching documents |\\n| `{{context.hits[]._id}}` | Document ID |\\n| `{{context.hits[]._source.*}}` | Any source document field |\\n\\n### Index Threshold context (`rule_type: index-threshold`)\\n\\n| Variable | Description |\\n|----------|-------------|\\n| `{{context.title}}` | Pre-built title |\\n| `{{context.message}}` | Pre-built summary |\\n| `{{context.conditions}}` | Condition description, e.g. `count greater than 4` |\\n| `{{context.value}}` | Aggregated value that crossed the threshold |\\n| `{{context.date}}` | ISO timestamp |\\n| `{{context.group}}` | Action group name |\\n\\n### Summary action variables (action frequency = summary)\\n\\n| Variable | Description |\\n|----------|-------------|\\n| `{{alerts.all.count}}` | Total alert count |\\n| `{{alerts.new.count}}` | New alerts count |\\n| `{{alerts.ongoing.count}}` | Ongoing alerts count |\\n| `{{alerts.recovered.count}}` | Recovered alerts count |\\n| `{{alerts.*.data}}` | Array of alert objects \\u2014 iterate with `{{#alerts.new.data}}` |\\n\\n### Mustache syntax tips\\n\\n| Pattern | Usage |\\n|---------|-------|\\n| `{{variable}}` | Standard output (auto-escaped) |\\n| `{{{variable}}}` | Raw output, no escaping |\\n| `{{#array}}...{{/array}}` | Iterate over array |\\n| `{{#bool}}...{{/bool}}` | Conditional block |\\n| `{{^bool}}...{{/bool}}` | Inverted conditional |\\n| `{{array.asJSON}}` | Render array as JSON |\\n| `{{{.}}}` | Dump entire context as JSON (debugging) |\\n\\n### Formatting helpers\\n\\n| Helper | Example |\\n|--------|---------|\\n| Date format | `{{#FormatDate}} {{{date}}} ; UTC ; YYYY-MM-DD HH:mm {{/FormatDate}}` |\\n| Math | `{{#EvalMath}} {{{context.value}}} * 100 {{/EvalMath}}` |\\n\\n### Example: rich Mattermost alert message\\n\\n```\\n:warning: **{{rule.name}}**\\n**Time:** {{#FormatDate}} {{{context.date}}} ; UTC ; YYYY-MM-DD HH:mm:ss {{/FormatDate}}\\n**Value:** {{context.value}} | **Condition:** {{context.conditions}}\\n{{#context.hits}}\\n- `{{_source.host.name}}`: {{_source.message}}\\n{{/context.hits}}\\n[View in Kibana]({{context.link}})\\n```\"}, \"uiState\": {}, \"data\": {\"aggs\": [], \"searchSource\": {\"query\": {\"query\": \"\", \"language\": \"kuery\"}, \"filter\": []}}}, \"enhancements\": {}}, \"panelIndex\": \"ag-mustache\", \"gridData\": {\"i\": \"ag-mustache\", \"x\": 24, \"y\": 38, \"w\": 24, \"h\": 22}}, {\"type\": \"visualization\", \"embeddableConfig\": {\"savedVis\": {\"title\": \"Mattermost Setup\", \"description\": \"\", \"type\": \"markdown\", \"params\": {\"fontSize\": 12, \"openLinksInNewTab\": false, \"markdown\": \"## Mattermost Setup\\n\\n### Auto-provisioned resources\\n\\nWhen Mattermost starts with the sandbox, the following are created:\\n\\n| Resource | Details |\\n|----------|---------|\\n| **Admin user** | `admin` / `Admin123!` |\\n| **Teams** | As configured (e.g., `SERVERS`) |\\n| **Channels** | `elastic-alerts` channel in each team |\\n| **Webhooks** | One incoming webhook per team |\\n\\n### Connector naming convention\\n\\nKibana connectors are named to match teams:\\n\\n```\\nMattermost - {TEAM_NAME} Team\\n```\\n\\nExample: `Mattermost - SERVERS Team`\\n\\nThis name must match **exactly** in your `.alert` file's `connector_name` field.\\n\\n### Accessing Mattermost\\n\\n- **URL**: [http://localhost:8065](http://localhost:8065)\\n- **Admin**: `admin` / `Admin123!`\\n- Alert messages appear in the `elastic-alerts` channel\\n\\n### Webhook flow\\n\\n```\\nKibana Rule fires\\n  \\u2192 Kibana Connector (webhook URL)\\n    \\u2192 Mattermost Incoming Webhook\\n      \\u2192 Channel message\\n```\"}, \"uiState\": {}, \"data\": {\"aggs\": [], \"searchSource\": {\"query\": {\"query\": \"\", \"language\": \"kuery\"}, \"filter\": []}}}, \"enhancements\": {}}, \"panelIndex\": \"ag-mattermost\", \"gridData\": {\"i\": \"ag-mattermost\", \"x\": 0, \"y\": 60, \"w\": 24, \"h\": 14}}, {\"type\": \"visualization\", \"embeddableConfig\": {\"savedVis\": {\"title\": \"Troubleshooting\", \"description\": \"\", \"type\": \"markdown\", \"params\": {\"fontSize\": 12, \"openLinksInNewTab\": false, \"markdown\": \"## Troubleshooting\\n\\n### Alert not firing\\n\\n- **Check rule status** in [Alerting Rules](/app/management/insightsAndAlerting/triggersActions/rules) \\u2014 look for errors\\n- **Check schedule** \\u2014 is `schedule_interval` appropriate for your data rate?\\n- **Test query manually** \\u2014 run the ES query in [Dev Tools](/app/dev_tools#/console) to verify matches\\n- **Check time window** \\u2014 if `time_window` is too small, transient data may be missed\\n\\n### Connector not found\\n\\nThe deploy script looks up connectors by name. Common issues:\\n- **Name mismatch** \\u2014 `connector_name` in `.alert` must match exactly (case-sensitive)\\n- **Connector not created** \\u2014 ensure Mattermost was started and the init process completed\\n- **Check connectors** \\u2014 go to [Connectors](/app/management/insightsAndAlerting/triggersActionsConnectors/connectors)\\n\\n### Message not appearing in Mattermost\\n\\n- **Check webhook URL** \\u2014 verify the connector's webhook URL is reachable from Kibana\\n- **Check Mattermost logs**: `podman logs mattermost`\\n- **Channel exists** \\u2014 verify `elastic-alerts` channel exists in the target team\\n- **Webhook enabled** \\u2014 Mattermost must have incoming webhooks enabled (the sandbox sets this)\\n\\n### Mustache template errors\\n\\n- Use `{{{.}}}` in your message to dump the full variable context \\u2014 helps discover available fields\\n- Ensure proper closing tags: `{{#section}}...{{/section}}`\\n- Use triple braces `{{{var}}}` for URLs to avoid HTML encoding issues\\n\\n### Deploy script errors\\n\\n```bash\\n# Check if Kibana is healthy\\ncurl -s -u elastic:changeme http://localhost:5601/api/status | jq '.status.overall.level'\\n\\n# List existing connectors\\ncurl -s -u elastic:changeme http://localhost:5601/api/actions/connectors -H \\\"kbn-xsrf: true\\\" | jq '.[].name'\\n\\n# List existing rules\\ncurl -s -u elastic:changeme http://localhost:5601/api/alerting/rules/_find -H \\\"kbn-xsrf: true\\\" | jq '.data[].name'\\n```\"}, \"uiState\": {}, \"data\": {\"aggs\": [], \"searchSource\": {\"query\": {\"query\": \"\", \"language\": \"kuery\"}, \"filter\": []}}}, \"enhancements\": {}}, \"panelIndex\": \"ag-troubleshoot\", \"gridData\": {\"i\": \"ag-troubleshoot\", \"x\": 24, \"y\": 60, \"w\": 24, \"h\": 14}}]", "timeRestore": false, "title": "Guide: Alerting & Mattermost", "version": 3}, "coreMigrationVersion": "8.8.0", "created_at": "2026-02-13T00:22:10.000Z", "id": "dev-guide-00000000-0000-0000-0000-000000000003", "managed": false, "references": [], "type": "dashboard", "typeMigrationVersion": "10.3.0", "updated_at": "2026-02-13T00:22:10.000Z", "version": "WzEsMV0="}
{"excludedObjects": [], "excludedObjectsCount": 0, "exportedCount": 1, "missingRefCount": 0, "missingReferences": []}
